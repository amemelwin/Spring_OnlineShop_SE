<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

  <head th:replace="fragments/common :: head('Create Order')" ></head>

  <body>
  	  <div class="text-center py-5 bg-secondary">Order</div>
  	  
  	  <!-- redirect hoem -->
  	  <form th:action="@{/}">
  	  	<button type="submit" id="home" class="btn btn-outline"></button>
  	  </form>
  	  
  	  <div class="mx-auto w-50 mt-5">
  	  	<!--  	<select class="form-select" name="shop" id="shop" >
				<option selected value=""></option>
				<option value="shop2"></option>
			</select> -->
  	  		<div class="d-flex flex-row">
  	  			<div class="col-1" >#id</div>
  	  			<div class="col-4 text-center">Name</div>
  	  			<div class="col-2 text-center">Price</div>
  	  			<div class="col-3 text-center">Qty</div>
  	  			<div class="col-2 d-flex flex-row justify-content-end">Total</div>
  	  		</div>
  	  		
  	  		<div id="cartList">
  	  			<!-- 
  	  				tableInject here
  	  			 -->
  	  		</div>
  	  		<div class=" d-flex flex-row justify-content-end">
  	  			<div class="col-2">
  	  				<div class="bg-dark" style="width:100%; height:2px;"></div>
  	  				<div class="d-flex flex-row justify-content-end mx-3 " style="font-weight:bold;"><span id="total" class="px-1" ></span> Ks</div>
  	  				<div class="bg-dark" style="width:100%; height:2px;"></div>  	  				
  	  			</div>
  	  		</div>
  	  		<!-- th:action="@{/order/create}" method="POST" -->
			<form id="test" th:action="@{/order/create}" method="POST" >
  	  			<input type="hidden" name="orderList" th:value="${orderList}">
  	  			<div th:text="*{name}"></div>
  	  			<div class="d-flex flex-row justify-content-center mt-3">
  	  				<button th:onclick="addOrderInfo()"  type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Create order</button>
  	  			</div>
  	  		</form>
  	  		
  	  		<!-- Modal -->
			<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered">
			    <div class="modal-content">
			      <div class="modal-header ">
			        <h5 class="col-11 modal-title text-center " id="staticBackdropLabel">Order Information</h5>
			        <button type="button" class="col-1 btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      </div>
			      <div class="modal-body">
			      	 <form role="form" method="POST" action="" >
			      		<div class="d-flex flex-row">
			  	  			<div class="col-4 text-center">Name</div>
			  	  			<div class="col-3 text-center">Qty</div>
			  	  			<div class="col-2 d-flex flex-row justify-content-end">Total</div>
			  	  		</div>
			  	  		<div id="rowOrderList">
			  	  		<!-- Row Inject here -->
			  	  		</div>
	                    <div class="form-group row py-sm-2 mb-0">
	                        <label class="control-label">Receiver Name</label>
	                        <div>
	                            <input type="text" class="form-control input-lg" name="name">
	                        </div>
	                    </div>
	                    <div class="form-group row py-sm-2 mb-0">
	                        <label class="control-label">Receiver Phone</label>
	                        <div>
	                            <input type="tel" class="form-control input-lg" name="phone">
	                        </div>
	                    </div>
	                    
					    <div class="form-group py-sm-2 ">
					    	<label class="control-label">Division</label>
					    	<div>					    	
							    <select class="form-select " aria-label="Default select example" >
								  <option th:each="division : ${divisionList}" 
	                                th:text="${division.name}" >
	                               </option>
								</select>
					    	</div>					     						     	
					    </div>
					    <div class="form-group row  py-sm-2 mb-0">
					    	<div>
					    		<label for="exampleFormControlTextarea1">Delivery Address</label>
						    	<textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
					    	</div>						    
						</div>
						<div class="form-group col py-sm-3 mb-0 d-flex flex justify-content-evenly ">
					        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					        <button type="submit" class="btn btn-primary">Order Confirm</button>
					    </div>
			        </form>			         
			      </div>
			      
			    </div>
			  </div>
			</div>
  	  </div>
  	  <script>
  	    const orderRowInject =  (orderList)=>{
  	    	const body = $("#rowOrderList");
  	    	let html = "";
  	    	orderList.map((orderList)=>{
  	    		 html += `
  	    			<div class="d-flex flex-row">
		  	  			<div class="col-4 text-center">${orderList.name}</div>
			  	  		<div class="col-3 text-center">${orderList.qty}</div>
		  	  			<div class="col-2 d-flex flex-row justify-content-end">${(orderList.qty*orderList.price).toLocaleString()} Ks</div>
	  	  			</div>  	    			
  	    		`;
  	    	});
  	    
  	    	body.html(html);
  	    	
  	    }
  	  	const tableInject = (orderList)=>{
  	  	const tableBody = $("#cartList");
  	  		let html = "";
  	  		orderList.map(({id,name,price,qty},i)=>{
  	  			html += `
	  	  			<div class="d-flex flex-row items-center py-2 px-3 ${i%2 == 0?'bg-white':'bg-light'}">
		  	  			<div class="col-1 my-auto" >${id}</div>
		  	  			<div class="col-4  my-auto">${name}</div>
		  	  			<div class="col-2 d-flex flex-row justify-content-end my-auto">${price.toLocaleString()} Ks</div>
		  	  			<div class="col-3 text-center">
		  	  				<div class="d-flex flex-row justify-content-center">
							  	<button onclick="minusQty(${id})" class="btn btn-outline minus" ><i class="bi bi-dash-square"></i></button>				  		
							  	<div class="btn" >${qty}</div>
							  	<button onclick="plusQty(${id})" class="btn btn-outline plus"><i class="bi bi-plus-square"></i></button>	
						  	</div>	
		  	  			</div>
		  	  			<div class="col-2 d-flex flex-row justify-content-end my-auto">${(qty*price).toLocaleString()} Ks</div>
		  	  		</div>
  	  			`;
  	  			
  	  		});
  	  	    $("#total").text( orderList.reduce((total,{qty,price})=>total+(qty*price),0).toLocaleString() );	
  	  		tableBody.html(html);
  	  	}
  	  	const addOrderInfo = ()=>{
  	  		let orderList1 = JSON.parse( $("input[name='orderList']").val() );
  	  		let updatedOrderList=orderList1.map((item)=> {
  	  			return item;
  	  		});
  	  		orderRowInject(updatedOrderList);
  	  		
  	  	}
  	  	const minusQty = (minusId)=>{
  	  		let [{id,name,price,qty}] = JSON.parse( $("input[name='orderList']").val() ).filter( (item)=> item.id==minusId );
  	  		let orderList = JSON.parse( $("input[name='orderList']").val() );
  	  		let updatedOrderList;
  	  		if(qty==1){ // remove item
  	  			updatedOrderList = orderList.filter((item)=> item.id != id);
  	  		}else{ // minus qty
  	  			updatedOrderList = orderList.map((item)=> {
  	  				if(item.id == id){
  	  					return {id,name,price,qty:qty-1};
  	  				}else{
  	  					return item;
  	  				}
  	  			})
  	  		}
  	  		// Redirect Home page when there is no item
  	  		if(updatedOrderList.length === 0){  	  			
  	  			$("#home").trigger('click');
  	  			return;
  	  		}
  	  		// Update table
  	  		tableInject(updatedOrderList);
  	  		addOrderInfo(updatedOrderList);
  	  		
  	  		// Update Input
  	  		$("input[name='orderList']").val( JSON.stringify(updatedOrderList) );
  	  	}
  	  	
  	  	const plusQty = (plusId)=>{
  	  		let [{id,name,price,qty}] = JSON.parse( $("input[name='orderList']").val() ).filter((item)=>item.id == plusId);
  	  		
  	  		let orderList = JSON.parse( $("input[name='orderList']").val() );
  	  		let updatedOrderList = orderList.map(({id,name,price,qty})=>{
  	  			if(id == plusId){
  	  				return {id,name,price,qty:qty+1};
  	  			}else{
  	  				return {id,name,price,qty};
  	  			}
  	  		});
  	  		
  	  		// Update table
  	  		tableInject(updatedOrderList);
  	  		// Update Input
  	  		$("input[name='orderList']").val( JSON.stringify(updatedOrderList) );
  	  		
  	  		
  	  		
  	  	}
  	  	
  	  	$(document).ready(function(){
  	  		// initail create table
  	  		let orderList = JSON.parse( $("input[name='orderList']").val() );
  	  		if(orderList.length === 0){
  	  			$("#home").trigger('click');
  	  		}else{  	  			
	  	  		tableInject(orderList);
  	  		}
  	  	});
  	  	
  	  </script>
  </body>
</html>